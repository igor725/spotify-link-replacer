// ==UserScript==
// @name         Spotify link replacer
// @namespace    https://igvx.ru/
// @version      1.4
// @description  Tiny userscript that replaces Spotify links in chats with embeded player
// @downloadURL  https://raw.githubusercontent.com/igor725/spotify-link-replacer/main/slr.user.js
// @updateURL    https://raw.githubusercontent.com/igor725/spotify-link-replacer/main/slr.meta.js
// @author       igor725
// @match        https://vk.com/*
// @match        https://web.telegram.org/z/*
// @icon         https://spotify.com/favicon.ico
// @grant        none
// @run-at       document-end
// ==/UserScript==
!function(){const d="https://open.spotify.com/",p=["track/","episode/","artist/","album/","show/","playlist/"],m={default:80,episode:152,artist:240,album:240,show:232,playlist:240},y=new RegExp(d+"(.+)/([a-z0-9]+)","i");const u={"vk.com":{"url-check":"/im","link-selector":"div.im-mess--text > a","msg-bloat":"div.im-mess--text > div > div.im_msg_media_link","scroll-fixer":()=>{const e=document.scrollingElement;e.scrollTopMax-e.scrollTop<550&&(e.scrollTop=e.scrollTopMax)},"post-process":({frame:e,name:t,self:s})=>{if("bloat"===t)s["scroll-fixer"]();else if("message"===t){const o=document.createElement("div");o.style.zIndex=998,o.style.position="absolute",o.style.top="0px",o.style.border="10px var(--vkui--color_background_content) solid",o.style.borderRadius="0.9rem",o.style.width="99%",o.style.height="97%",o.style.margin="0",o.style.padding="0",o.style.left="-8px",o.style.pointerEvents="none",e.appendChild(o)}}},"web.telegram.org":{"url-check":"/a/","link-selector":"div.text-content > a.text-entity-link","scroll-fixer":()=>{const e=document.querySelector(".MessageList.scrolled");null!=e&&e.scrollTopMax-e.scrollTop<550&&(e.scrollTop=e.scrollTopMax)},"post-process":({frame:e,message:t})=>{e.style.overflow="hidden",e.style.marginTop="0",e.style.borderRadius="0.9rem",e.querySelector("iframe").style.marginTop="0",e.querySelector("a").style.top="0";const s=t.parentNode.parentNode,o=(s.style.background="transparent",s.style.padding="0",s.querySelector(".svg-appendix")),l=(o&&(o.style.display="none"),s.querySelector(".WebPage")),r=(l&&(l.style.display="none"),s.querySelector(".MessageMeta"));r&&(r.style.display="none")}}}[location.host];if(u){const f=(e,t)=>{if(u[e])return(t.self=u)[e](t)};setInterval(()=>{if(!u["url-check"]||location.pathname===u["url-check"]){var t=Array.from(document.querySelectorAll(u["link-selector"]+":not([us-slr-processed='1'])"));for(let e=0;e<t.length;e++){const l=t[e];if((e=>{e=e.getBoundingClientRect();return 0<=e.top&&0<=e.left&&e.bottom<=(window.innerWidth||document.documentElement.clientHeight)&&e.bottom<=(window.innerWidth||document.documentElement.clientWidth)})(l)){l.setAttribute("us-slr-processed",1);const r=decodeURIComponent(l.href);if((t=>{var e=t.indexOf(d);if(-1==e)return!1;const s=d.length+e;return p.find(e=>t.indexOf(e,s)==s)})(r)){const n=l.parentNode;var s=r.match(y);s&&2<s.length&&22==s[2].length&&(f("pre-process",{name:"message",message:n}),s=((e,t)=>{t=e+"/"+t;const s=document.createElement("div"),o=(s.style.position="relative",s.style.height=(m[e]||m.default)+"px",document.createElement("iframe")),l=(void 0!==u["scroll-fixer"]&&o.addEventListener("load",u["scroll-fixer"]),o.style.height="100%",o.src=d+"embed/"+t,o.allow="encrypted-media",o.style.marginTop="6px",o.style.minWidth="380px",o.style.width="100%",o.style.border="0px",document.createElement("a"));return l.style.zIndex="999",l.style.position="absolute",l.style.right="8px",l.style.top="15px",l.style.width="16px",l.style.height="20px",l.style.opacity="0",l.href="spotify:"+t,l.title="Play on Spotify",s.appendChild(o),s.appendChild(l),s})(s[1],s[2]),n.setAttribute("us-slr-processed",1),n.insertBefore(s,l),l.remove(),f("post-process",{name:"message",message:n,frame:s}))}}}if(void 0!==u["msg-bloat"]){var o=Array.from(document.querySelectorAll(u["msg-bloat"]+":not([us-slr-processed='1'])"));for(let e=0;e<o.length;e++){const i=o[e],a=i.parentNode;if(i.setAttribute("us-slr-processed",1),a){const c=a.parentNode;1==c.getAttribute("us-slr-processed")&&(a.remove(),f("post-process",{name:"bloat"}))}}}}},100)}else console.error("No embed rules for current domain found")}();
