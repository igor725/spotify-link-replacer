// ==UserScript==
// @name         Spotify link replacer
// @namespace    https://igvx.ru/
// @version      1.5
// @description  Tiny userscript that replaces Spotify links in chats with embeded player
// @downloadURL  https://raw.githubusercontent.com/igor725/spotify-link-replacer/main/slr.user.js
// @updateURL    https://raw.githubusercontent.com/igor725/spotify-link-replacer/main/slr.meta.js
// @author       igor725
// @match        https://vk.com/*
// @match        https://web.telegram.org/a/*
// @icon         https://spotify.com/favicon.ico
// @grant        none
// @run-at       document-end
// ==/UserScript==
!function(){const p="https://open.spotify.com/",m=["track/","episode/","artist/","album/","show/","playlist/"],y={default:80,episode:152,artist:240,album:240,show:232,playlist:240},u=new RegExp(p+"(.+)/([a-z0-9]+)","i");const g={"vk.com":{"url-check":"/im","link-selector":"div.im-mess--text > a","msg-bloat":"div.im-mess--text > div > div.im_msg_media_link","scroll-fixer":()=>{var e=document.scrollingElement;e.scrollTopMax-e.scrollTop<550&&(e.scrollTop=e.scrollTopMax)},"post-process":({frame:e,name:t,self:o})=>{"bloat"===t?o["scroll-fixer"]():"message"===t&&((o=document.createElement("div")).style.zIndex=998,o.style.position="absolute",o.style.top="0px",o.style.border="10px var(--vkui--color_background_content) solid",o.style.borderRadius="0.9rem",o.style.width="99%",o.style.height="97%",o.style.margin="0",o.style.padding="0",o.style.left="-8px",o.style.pointerEvents="none",e.appendChild(o))}},"web.telegram.org":{"url-check":"/a/","link-selector":"div.text-content > a.text-entity-link","scroll-fixer":()=>{var e=document.querySelector(".MessageList.scrolled");null!=e&&e.scrollTopMax-e.scrollTop<550&&(e.scrollTop=e.scrollTopMax)},"post-process":({frame:e,message:t})=>{e.style.overflow="hidden",e.style.marginTop="0",e.style.borderRadius="0.9rem",e.querySelector("iframe").style.marginTop="0",e.querySelector("a").style.top="0";e=t.parentNode.parentNode,e.style.background="transparent",e.style.padding="0",t=e.querySelector(".svg-appendix"),t&&(t.style.display="none"),t=e.querySelector(".WebPage"),t&&(t.style.display="none"),t=e.querySelector(".MessageMeta");t&&(t.style.display="none")}}}[location.host];if(g){const f=(e,t)=>{if(g[e])return(t.self=g)[e](t)};setInterval(()=>{if(!g["url-check"]||location.pathname===g["url-check"]){var t,o,s,l=Array.from(document.querySelectorAll(g["link-selector"]+":not([us-slr-processed='1'])"));for(let e=0;e<l.length;e++){var r,n,i=l[e];(e=>{e=e.getBoundingClientRect();return 0<=e.top&&0<=e.left&&e.bottom<=(window.innerWidth||document.documentElement.clientHeight)&&e.bottom<=(window.innerWidth||document.documentElement.clientWidth)})(i)&&(i.setAttribute("us-slr-processed",1),(t=>{var e=t.indexOf(p);if(-1==e)return!1;const o=p.length+e;return m.find(e=>t.indexOf(e,o)==o)})(n=decodeURIComponent(i.href)))&&(r=i.parentNode,n=n.match(u))&&2<n.length&&22==n[2].length&&(f("pre-process",{name:"message",message:r}),t=n[1],n=n[2],s=o=void 0,n=t+"/"+n,(o=document.createElement("div")).style.position="relative",o.style.height=(y[t]||y.default)+"px",t=document.createElement("iframe"),void 0!==g["scroll-fixer"]&&t.addEventListener("load",g["scroll-fixer"]),t.style.height="100%",t.src=p+"embed/"+n,t.allow="encrypted-media",t.style.marginTop="6px",t.style.minWidth="380px",t.style.width="100%",t.style.border="0px",(s=document.createElement("a")).style.zIndex="999",s.style.position="absolute",s.style.right="8px",s.style.top="15px",s.style.width="16px",s.style.height="20px",s.style.opacity="0",s.href="spotify:"+n,s.title="Play on Spotify",o.appendChild(t),o.appendChild(s),n=o,r.setAttribute("us-slr-processed",1),r.insertBefore(n,i),i.remove(),f("post-process",{name:"message",message:r,frame:n}))}if(void 0!==g["msg-bloat"]){var a=Array.from(document.querySelectorAll(g["msg-bloat"]+":not([us-slr-processed='1'])"));for(let e=0;e<a.length;e++){var d=a[e],c=d.parentNode;d.setAttribute("us-slr-processed",1),c&&1==c.parentNode.getAttribute("us-slr-processed")&&(c.remove(),f("post-process",{name:"bloat"}))}}}},100)}else console.error("No embed rules for current domain found")}();
