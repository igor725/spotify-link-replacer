// ==UserScript==
// @name         Spotify link replacer
// @namespace    https://igvx.ru/
// @version      1.3
// @description  Tiny userscript that replaces Spotify links in chats with embeded player
// @downloadURL  https://raw.githubusercontent.com/igor725/spotify-link-replacer/main/slr.user.js
// @updateURL    https://raw.githubusercontent.com/igor725/spotify-link-replacer/main/slr.meta.js
// @author       igor725
// @match        https://vk.com/*
// @match        https://web.telegram.org/z/*
// @icon         https://spotify.com/favicon.ico
// @grant        none
// @run-at       document-end
// ==/UserScript==
!function(){const n="https://open.spotify.com/",i=["track/","episode/","artist/","album/","show/","playlist/"],a={default:80,episode:152,artist:240,album:240,show:232,playlist:240},c=new RegExp(n+"(.+)/([a-z0-9]+)","i");const d={"vk.com":{"url-check":"/im","link-selector":"div.im-mess--text > a","msg-bloat":"div.im-mess--text > div > div.im_msg_media_link","scroll-fixer":()=>{let e=document.scrollingElement;e.scrollTopMax-e.scrollTop<550&&(e.scrollTop=e.scrollTopMax)},"post-process":({name:e,self:t})=>{"bloat"===e&&t["scroll-fixer"]()}},"web.telegram.org":{"url-check":"/z/","link-selector":"p.text-content > a.text-entity-link","scroll-fixer":()=>{let e=document.querySelector(".MessageList.scrolled");null!=e&&e.scrollTopMax-e.scrollTop<550&&(e.scrollTop=e.scrollTopMax)},"post-process":({frame:e,message:t})=>{e.style.overflow="hidden",e.style.marginTop="0",e.style.borderRadius="0.375rem",e.querySelector("iframe").style.marginTop="0",e.querySelector("a").style.top="0";let l=t.parentNode.parentNode,o=(l.style.background="transparent",l.style.padding="0",l.querySelector(".svg-appendix")),s=(o&&(o.style.display="none"),l.querySelector(".WebPage")),r=(s&&(s.style.display="none"),l.querySelector(".MessageMeta"));r&&(r.style.display="none")}}}[location.host];if(d){let r=(e,t)=>{if(d[e])return(t.self=d)[e](t)};setInterval(()=>{if(!d["url-check"]||location.pathname===d["url-check"]){var t=Array.from(document.querySelectorAll(d["link-selector"]+":not([us-slr-processed='1'])"));for(let e=0;e<t.length;e++){let l=t[e];if((e=>{e=e.getBoundingClientRect();return 0<=e.top&&0<=e.left&&e.bottom<=(window.innerWidth||document.documentElement.clientHeight)&&e.bottom<=(window.innerWidth||document.documentElement.clientWidth)})(l)){l.setAttribute("us-slr-processed",1);let t=decodeURIComponent(l.href);if((t=>{var e=t.indexOf(n);if(-1==e)return!1;let l=n.length+e;return i.find(e=>t.indexOf(e,l)==l)})(t)){let e=l.parentNode;var o=t.match(c);o&&2<o.length&&22==o[2].length&&(r("pre-process",{name:"message",message:e}),o=((e,t)=>{t=e+"/"+t;let l=document.createElement("div"),o=(l.style.position="relative",l.style.height=(a[e]||a.default)+"px",document.createElement("iframe")),s=(void 0!==d["scroll-fixer"]&&o.addEventListener("load",d["scroll-fixer"]),o.style.height="100%",o.src=n+"embed/"+t,o.allow="encrypted-media",o.style.marginTop="6px",o.style.minWidth="380px",o.style.width="100%",o.style.border="0px",document.createElement("a"));return s.style.zIndex="999",s.style.position="absolute",s.style.right="0px",s.style.top="6px",s.style.width="30px",s.style.height="35px",s.style.opacity="0",s.href="spotify:"+t,s.title="Play on Spotify",l.appendChild(o),l.appendChild(s),l})(o[1],o[2]),e.setAttribute("us-slr-processed",1),e.insertBefore(o,l),l.remove(),r("post-process",{name:"message",message:e,frame:o}))}}}if(void 0!==d["msg-bloat"]){var s=Array.from(document.querySelectorAll(d["msg-bloat"]+":not([us-slr-processed='1'])"));for(let l=0;l<s.length;l++){let e=s[l],t=e.parentNode;if(e.setAttribute("us-slr-processed",1),t){let e=t.parentNode;1==e.getAttribute("us-slr-processed")&&(t.remove(),r("post-process",{name:"bloat"}))}}}}},100)}else console.error("No embed rules for current domain found")}();
